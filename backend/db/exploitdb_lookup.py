import csv
import os
from typing import List

EXPLOIT_DB_CSV = os.path.join(os.path.dirname(__file__), "files_exploits.csv")

def search_exploitdb(vulnerability_name: str) -> List[dict]:
    """
    Searches a local CSV snapshot of ExploitDB for matching titles based on keyword.
    """
    results = []
    try:
        with open(EXPLOIT_DB_CSV, newline='', encoding='utf-8', errors='ignore') as csvfile:
            reader = csv.DictReader(csvfile)
            for row in reader:
                if vulnerability_name.lower() in row['description'].lower():
                    results.append({
                        "id": row["id"],
                        "description": row["description"],
                        "url": f"https://www.exploit-db.com/exploits/{row['id']}"
                    })

        return results[:5]  # limit to top 5 matches

    except FileNotFoundError:
        return [{"error": "ExploitDB CSV not found"}]
    except Exception as e:
        return [{"error": str(e)}]
